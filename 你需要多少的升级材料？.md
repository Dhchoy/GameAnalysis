# 你需要多少的升级材料？

## 每次只能升一级

假设某装备道具从 $n-1$ 级升级到 $n$ 级需要消耗成本为 $cost_n$，但升级的过程并不总是顺利的，该升级以 $p_{n-1}$ 的概率升级成功，以 $p_m$ 的概率回退到 $m$ 级，其中 $m<n$. 且满足 $\sum_{m=0}^{n} p_m =1$. 记 $pay_n$ 是把装备道具升级为$n$ 级的累计消费. 那么，我们下面来对装备升级到 $pay_n$ 的期望花费进行计算.

1. 如果装备在 $n$ 级升级失败，则回退到 $m$ 级以后，则会造成装备价值的损失，损失期望为对损失价值与损失期望之积的和：
   $$
   loss_n = \sum_{m=0}^n (pay_n - pay_m)\times p_m.
   $$

2. 则装备在 $n​$ 级升级时候的花销为，固定消耗成本和损失期望的和，即 $$loss_n+ cost_n​$$.

3. 因为装备从 $n$ 级升级至 $n+1$ 级的成功概率为 $p_{n+1}$，则升级成功所需要升级的期望次数为几何概率的首次成功期望$$\frac{1}{p_{n+1}}$$ ，从而得到升到 $n+1$ 级的期望花费为:
   $$
   pay_{n+1} = pay_n +(loss_n+cost_n)\times\frac{1}{p_{n+1}}.
   $$

4. 对公式进行变形，还可以看到 $$(pay_{n+1} - pay_{n})\times p_{n+1} = loss_n + cost_n$$，即从 $n$ 级升到 $n+1$ 的期望花费，等于从 $n+1$ 回退到 $n$ 的期望损失. 也可以认为是，升级后增值期望等于该升值的期望花销. 如果受外部条件影响使等式两边失衡，则会影响升级进行方向.

5. 再进行变形，即 $$cost_n = (pay_{n+1} - pay_n)\times p_{n+1} - loss_n$$，花费等于期望收益. 利用矩阵表示为 $$cost_n = (pay_m - pay_n)^T_{n+1}\cdot (p_m)_{n+1}$$ 也给计算带来了新的思路。 

### 例：

某装备升级花销和概率转移矩阵如下表：

| 消耗 $$cost_n$$ | $n$  | 0                | 1                | 2                | 3                |
| ------------- | ---- | ---------------- | ---------------- | ---------------- | ---------------- |
| 100           | 0    | $$ \frac{1}{3}$$ | $$ \frac{2}{3}$$ | $$0$$            | $$0$$            |
| 200           | 1    | $$ \frac{1}{3}$$ | $$ \frac{1}{3}$$ | $$ \frac{1}{3}$$ | $$0$$            |
| 400           | 2    | $$ \frac{1}{4}$$ | $$ \frac{1}{4}$$ | $$ \frac{1}{4}$$ | $$ \frac{1}{4}$$ |
| 0             | 3    | $$0$$            | $$0$$            | $$0$$            | $$1$$            |

对应计算表为：

| 等级 $n$ | 期望损失 $$loss_n$$               | 期望成本 $loss_n+cost_n$ | 期望花费 $pay_n$ |
| ------ | ----------------------------- | -------------------- | ------------ |
| 0      | 0                             | 100                  | 0            |
| 1      | $$150\times \frac{1}{3} =50$$ | 250                  | 150          |
| 2      | $$225+187.5=412.5$$           | 812.5                | 900          |
| 3      | 0                             | 0                    | 4150         |

有了期望花费 $pay_n$ 之后，也可以根据需要，来设置期望成本，以达成回收目的. 从 $loss_n+cost_n$ 来看，控制成本有两个方法，一是增大 $cost_n$，一是减小成功概率来增加 $loss_n$. 这即是说，**玩家在选择升级方式时候，应该理性选择，为提高成功率而盲目增加投入并不见得是最合理的选择**. 

## 每次能跨等级升级